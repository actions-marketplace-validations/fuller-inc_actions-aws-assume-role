name: test
on:
  push:
  pull_request:

jobs:
  provider:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up Go 1.16
        uses: actions/setup-go@v2
        with:
          go-version: "1.16"

      - name: restore cache
        uses: actions/cache@v2
        with:
          path: ~/go/pkg/mod
          key: go-${{ hashFiles('go.sum') }}
          restore-keys: |
            go-
      - name: Test
        run: |
          make test
        working-directory: provider/assume-role

  action:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v1
        with:
          node-version: "12"

      - name: build
        run: |
          npm ci
          npm run build
        working-directory: action

      - name: Test
        uses: ./
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::445285296882:role/assume-role-test

      - run: aws sts get-caller-identity
